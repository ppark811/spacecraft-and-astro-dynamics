%MAE 789
%Project - Kanes
%Paul Park

clear 
close all
clc

%---Constants---%
%Constraint torques
k0 = 0.0172;    % Nm/rad
k1 = 5.62;      % Nm/rad^3
k4 = 910;       % Nm/rad^9
b0 = 0.000201;  % Nm/rad.s
b1 = 0.0127;    % Nm/rad^3 .s
g = 9.81;       % m/s^2

% Pendulum components
L = 0.0263;     % m
m = 0.032;      % kg
r1 = -0.0737;   % m
r2 = 0.706;     % m
r3 = 0.0584;    % m

%---Timespan---%
tspan = [0 0.4]; %0 - 0.4 sec

%---Initial Conditions---%
% Order:
% q1, q2, dq1, dq2
% v1, v2, v3
% dv1,dv2,dv3
% phi, theta, psi
% dphi, dtheta, dpsi
%case one has acceleration pulse as 20
q0 = [0.1;0.1;0;0;0;0;0;20;0;0;0;0;0;0;0;0]; 

%---ODE function call---%
options = odeset('RelTol',1e-3,'AbsTol',1e-6,'InitialStep',1e-5);
[t,q] = ode45(@(t,q) odefun(t,q,k0,k1,k4,b0,b1,g,L,m,r1,r2,r3), tspan, q0, options);

%---Plotting---%

 %q1 angle
figure(1)
plot(t,q(:,1))
xlabel('Time (s)')
ylabel('Angle (rad)')
title('Angle of q1 vs Time')

 %q2 angle
figure(2)
plot(t,q(:,2))
xlabel('Time (s)')
ylabel('Angle (rad)')
title('Angle of q2 vs Time')

%---ODE function---%
function [dqdt] = odefun(t,q,k0,k1,k4,b0,b1,g,L,m,r1,r2,r3)

    %---Creating time dependent variables:---%
   %q1         q2
    q1 = q(1); q2 = q(2);                   
    
   %dq1 (u1)   dq2 (u2)
    q3 = q(3); q4 = q(4);                   
    
   %v1         v2         v3
    q5 = q(5); q6 = q(6); q7 = q(7);    

   %dv1        dv2        dv3 
    q8 = q(8); q9 = q(9); q10 = q(10);      

   %phi          theta        psi
    q11 = q(11); q12 = q(12); q13 = q(13); 

   %dphi         dtheta       dpsi  
    q14 = q(14); q15 = q(15); q16 = q(16);       

    %---Variable subsitutes---%
    % angular velocity components
    w1 = q14 - q16*sin(q12);
    w2 = q15*cos(q11) + q16*sin(q11)*cos(q12);
    w3 = -q15*sin(q11) + q16*cos(q11)*cos(q12);
    dw1=(-1).*(2.*q15.*q16.*cos(q13).*sin(q12)+q15.^2.*cos(q12).*sin(q13)+ ...
        q16.^2.*cos(q12).*sin(q13)).*(cos(q11).*cos(q13).*sin(q12)+sin(q11).* ...
        sin(q13))+(q16.*cos(q12).*cos(q13)+(-1).*q15.*sin(q12).*sin(q13)).*( ...
        q15.*cos(q11).*cos(q12).*cos(q13)+q14.*((-1).*cos(q13).*sin(q11).*sin( ...
        q12)+cos(q11).*sin(q13))+q16.*(cos(q13).*sin(q11)+(-1).*cos(q11).*sin( ...
        q12).*sin(q13)))+cos(q11).*cos(q12).*((-1).*q15.^2.*cos(q11).*sin(q12).* ...
        sin(q13)+2.*q14.*q16.*((-1).*cos(q13).*sin(q11).*sin(q12)+cos(q11).*sin( ...
        q13))+2.*q15.*cos(q12).*(q16.*cos(q11).*cos(q13)+(-1).*q14.*sin(q11).* ...
        sin(q13))+q14.^2.*(cos(q13).*sin(q11)+(-1).*cos(q11).*sin(q12).*sin(q13) ...
        )+q16.^2.*(cos(q13).*sin(q11)+(-1).*cos(q11).*sin(q12).*sin(q13)))+(-1) ...
        .*q14.*cos(q12).*sin(q11).*(q15.*cos(q11).*cos(q12).*sin(q13)+q16.*(cos( ...
        q11).*cos(q13).*sin(q12)+sin(q11).*sin(q13))+(-1).*q14.*(cos(q11).*cos( ...
        q13)+sin(q11).*sin(q12).*sin(q13)))+(-1).*q15.*cos(q11).*sin(q12).*( ...
        q15.*cos(q11).*cos(q12).*sin(q13)+q16.*(cos(q11).*cos(q13).*sin(q12)+ ...
        sin(q11).*sin(q13))+(-1).*q14.*(cos(q11).*cos(q13)+sin(q11).*sin(q12).* ...
        sin(q13)))+(q15.*cos(q12).*sin(q11).*sin(q13)+q16.*(cos(q13).*sin(q11).* ...
        sin(q12)+(-1).*cos(q11).*sin(q13))+q14.*((-1).*cos(q13).*sin(q11)+cos( ...
        q11).*sin(q12).*sin(q13))).*(q15.*cos(q11).*cos(q12).*sin(q13)+q16.*( ...
        cos(q11).*cos(q13).*sin(q12)+sin(q11).*sin(q13))+(-1).*q14.*(cos(q11).* ...
        cos(q13)+sin(q11).*sin(q12).*sin(q13)))+(-1).*(cos(q13).*sin(q11)+(-1).* ...
        cos(q11).*sin(q12).*sin(q13)).*((-1).*q15.^2.*sin(q11).*sin(q12).*sin( ...
        q13)+2.*q15.*cos(q12).*(q16.*cos(q13).*sin(q11)+q14.*cos(q11).*sin(q13)) ...
        +2.*q14.*q16.*(cos(q11).*cos(q13).*sin(q12)+sin(q11).*sin(q13))+(-1).* ...
        q14.^2.*(cos(q11).*cos(q13)+sin(q11).*sin(q12).*sin(q13))+(-1).*q16.^2.* ...
        (cos(q11).*cos(q13)+sin(q11).*sin(q12).*sin(q13)));
    dw2=q15.^2.*(cos(q11).*sin(2.*q12)+cos(q13).*sin(2.*q12)+(-1).*cos(2.*q12).* ...
        sin(q11).*sin(q13))+q14.*cos(q12).*(q16.*cos(q11).*cos(q12).*cos(q13)+ ...
        q14.*(cos(q11).*sin(q12)+(-1).*cos(q12).*sin(q11).*sin(q13)))+q15.*( ...
        q16.*cos(q12).*((-1).*cos(q13).*sin(q11).*sin(q12)+cos(q12).*sin(q13))+ ...
        q14.*(cos(q12).^2.*sin(q11)+(-2).*sin(q11).*sin(q12).^2+(-3).*cos(q11).* ...
        cos(q12).*sin(q12).*sin(q13)));
    dw3=(-1).*(cos(q13).*sin(q11).*sin(q12)+(-1).*cos(q11).*sin(q13)).*(q15.^2.* ...
        cos(q12).*cos(q13)+q16.^2.*cos(q12).*cos(q13)+(-2).*q15.*q16.*sin(q12).* ...
        sin(q13))+q14.*cos(q11).*cos(q12).*(q15.*cos(q11).*cos(q12).*cos(q13)+ ...
        q14.*((-1).*cos(q13).*sin(q11).*sin(q12)+cos(q11).*sin(q13))+q16.*(cos( ...
        q13).*sin(q11)+(-1).*cos(q11).*sin(q12).*sin(q13)))+(-1).*q15.*sin(q11) ...
        .*sin(q12).*(q15.*cos(q11).*cos(q12).*cos(q13)+q14.*((-1).*cos(q13).* ...
        sin(q11).*sin(q12)+cos(q11).*sin(q13))+q16.*(cos(q13).*sin(q11)+(-1).* ...
        cos(q11).*sin(q12).*sin(q13)))+(cos(q11).*cos(q13)+sin(q11).*sin(q12).* ...
        sin(q13)).*((-1).*q15.^2.*cos(q13).*sin(q11).*sin(q12)+q14.^2.*((-1).* ...
        cos(q13).*sin(q11).*sin(q12)+cos(q11).*sin(q13))+q16.^2.*((-1).*cos(q13) ...
        .*sin(q11).*sin(q12)+cos(q11).*sin(q13))+2.*q15.*cos(q12).*(q14.*cos( ...
        q11).*cos(q13)+(-1).*q16.*sin(q11).*sin(q13))+2.*q14.*q16.*(cos(q13).* ...
        sin(q11)+(-1).*cos(q11).*sin(q12).*sin(q13)))+(-1).*(q15.*cos(q13).*sin( ...
        q12)+q16.*cos(q12).*sin(q13)).*(q15.*cos(q12).*cos(q13).*sin(q11)+q14.*( ...
        cos(q11).*cos(q13).*sin(q12)+sin(q11).*sin(q13))+(-1).*q16.*(cos(q11).* ...
        cos(q13)+sin(q11).*sin(q12).*sin(q13)))+(q15.*cos(q12).*sin(q11).*sin( ...
        q13)+q16.*(cos(q13).*sin(q11).*sin(q12)+(-1).*cos(q11).*sin(q13))+q14.*( ...
        (-1).*cos(q13).*sin(q11)+cos(q11).*sin(q12).*sin(q13))).*(q15.*cos(q12) ...
        .*cos(q13).*sin(q11)+q14.*(cos(q11).*cos(q13).*sin(q12)+sin(q11).*sin( ...
        q13))+(-1).*q16.*(cos(q11).*cos(q13)+sin(q11).*sin(q12).*sin(q13)))+(-1) ...
        .*cos(q12).*sin(q11).*(q15.^2.*cos(q11).*cos(q13).*sin(q12)+2.*q15.*cos( ...
        q12).*(q14.*cos(q13).*sin(q11)+q16.*cos(q11).*sin(q13))+q14.^2.*(cos( ...
        q11).*cos(q13).*sin(q12)+sin(q11).*sin(q13))+q16.^2.*(cos(q11).*cos(q13) ...
        .*sin(q12)+sin(q11).*sin(q13))+(-2).*q14.*q16.*(cos(q11).*cos(q13)+sin( ...
        q11).*sin(q12).*sin(q13)));

    % Torque components
    T1 = -(b0 + b1*q2^2)*q3;
    T2 = -(k0 + k1*q2^2 + k4*q2^8)*q2 - (b0 + b1*q2^2)*q4;

    % Z equations
    Z1 = q8 + q7*w2 - q6*w3 + (r3 + L*cos(q2))*dw2 - (r2 + L*sin(q1)*sin(q2))*dw3 - (r1 + L*sin(q2)*cos(q1))*(w2^2 + w3^2) + (r2 + L*sin(q2)*sin(q1))*w1*w2 + (r3 + L*cos(q2))*w1*w2;
    Z2 = q9 + q5*w3 - q7*w1 - (r3 + L*cos(q2))*dw1 + (r1 + L*sin(q2)*cos(q1))*dw3 - (r2 + L*sin(q2)*sin(q1))*(w1^2 + w3^2) + (r1 + L*sin(q2)*cos(q1))*w1*w2 + (r3 + L*cos(q2))*w2*w3;
    Z3 = q10 + q6*w1 - q5*w2 + (r2 +L*sin(q2)*sin(q1)) + dw1 - (r1 + L*sin(q2)*cos(q1))*dw2 - (r3 + L*cos(q2))*(w1^2 + w2^2) + (r1 + L*sin(q2)*cos(q1))*w1*w3 + (r2 + L*sin(q2)*sin(q1))*w2*w3;
    Z4 = 2*L*(sin(q2)*q4*w2 - (cos(q2)*sin(q1)*q4 + sin(q2)*cos(q1)*q3)*w3);
    Z5 = 2*L*(-sin(q2)*q4*w1 + (cos(q2)*cos(q1)*q4 - sin(q2)*sin(q1)*q3)*w3);
    Z6 = 2*L*((cos(q2)*sin(q1)*q4 + sin(q2)*cos(q1)*q3)*w1 - (cos(q2)*cos(1)*q4 - sin(q2)*sin(q1)*q3)*w2);


    %---Creating 1st order ODEs---%
    dq1 = q3;
    dq2 = q4;
    dq3 = (-2*L*cos(q2)*q3*q4 + sin(q1)*(Z1 + Z4) - cos(q1)*(Z2 + Z5) + ...
        g*(sin(q1)*sin(q12) + cos(q1)*cos(q12)*sin(q11)) + (T1*sin(q2))/(m*L));
    dq4 = (1/L) * (L*sin(q2)*cos(q2)*q4^2 - cos(q2)*cos(q1)*(Z1 + Z4) - ...
        cos(q2)*sin(q1)*(Z2 + Z5) + sin(q2)*(Z3 + Z6) + g*(-cos(q2)*cos(q1)*sin(q12) ...
        + cos(q2)*sin(q1)*cos(q12)*sin(q11) - sin(q2)*cos(q12)*cos(q11)) + (T2/(m*L)));
    dq5 = q8;
    dq6 = q9;
    dq7 = q10;
    dq8 = 0;

    dq9 = 0;
    dq10 = 0;
    dq11 = q14;
    dq12 = q15;
    dq13 = q16;
    dq14 = 0;
    dq15 = 0;
    dq16 = 0;

    dqdt=[dq1;dq2;dq3;dq4;dq5;dq6;dq7;dq8;dq9;dq10;dq11;dq12;dq13;dq14;dq15;dq16];

end
